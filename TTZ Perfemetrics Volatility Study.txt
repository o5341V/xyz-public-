// This source code is subject to the terms of the Mozilla Public License 2.0 at https://mozilla.org/MPL/2.0/
// Â© Uni_ve12se

//@version=4
study("Perfemetrics Volatility Study")

// Switcher
visualization = input(title="Visualization", options = ["Bilateral", "Absolute Delta", "Unilateral"], defval="Bilateral")
// Switcher

// Intra-bar Volatility Module Open

volatilityTotal = (high/low)-1
volatilityNegative = visualization=="Unilateral" ? (open/low)-1 : 1-(open/low)
volatilityPositive = 1-(open/high)
volatilitySignal = visualization=="Unilateral" ? abs(1-(open/close)) : 1-(open/close)
volatilityDelta = visualization=="Absolute Delta" or visualization=="Unilateral" ? abs(abs(volatilityPositive)-abs(volatilityNegative)) : abs(volatilityPositive)-abs(volatilityNegative)

// Intra-bar Volatility Module Close

period = input(30, "Average Volatility Period")

avgTT = sma(volatilityTotal, period)
avgVN = sma(volatilityNegative, period)
avgVP = sma(volatilityPositive, period)
avgVS = sma(volatilitySignal, period)
avgVD = sma(volatilityDelta, period)

plot(avgTT, color=color.white, title="Average Total Volatility", display=display.none)
plot(avgVP, color=color.lime, title="Average Positive Volatility", display=display.none)
plot(avgVN, color=#a22c6b, title="Average Negative Volatility", display=display.none)
plot(avgVS, color=color.orange, title="Average Signal Volatility", display=display.none)
plot(avgVD, color=#c4cd90, title="Average Delta Volatility", display=display.none)

thresholdTop = input(0.1, "Threshold Top")
thresholdBottom = input(-0.1, "Threshold Bottom")
highlighterTop = plot(thresholdTop, color=color.black, title="Threshold Top", display=display.none, editable=false)
highlighterBottom = plot(thresholdBottom, color=color.black, title="Threshold Bottom", display=display.none, editable=false)
fill(highlighterTop, highlighterBottom, color=#131722, transp=90, title="Highlighter")

// Plot Intra-Bar Volatility
plot(volatilityTotal, color=#d1d4dc, style=plot.style_histogram, title="Total Volatility")
plot(volatilityPositive, color=color.lime, style=plot.style_histogram, title="Positive Volatility")
plot(volatilityNegative, color=#d03889, style=plot.style_histogram, title="Negative Volatility")
plot(volatilitySignal, color=color.orange, style=plot.style_histogram, title="Signal Volatility", display=display.none)
plot(volatilityDelta, color=#c4cd90, style=plot.style_cross, title="Volatility Delta", display=display.none)

// Standard Cross-Bar Volatility Formulas
CB_volatilityTotal = abs((high[1]/low[0])-1)
CB_volatilityPositive = 1-(high[1]/high[0])
CB_volatilityNegative = visualization=="Unilateral" ? (low[1]/low[0])-1 : 1-(low[1]/low[0])
CB_volatilityArtifact = visualization=="Unilateral" ? (close[1]/open[0])-1 : 1-(close[1]/open[0])

// Plot Standard Cross-Bar Volatility
plot(CB_volatilityTotal, color=#d1d4dc, style=plot.style_histogram, title="Cross-Bar Total Volatility", display=display.none)
plot(CB_volatilityPositive, color=#568158, style=plot.style_histogram, title="Cross-Bar Positive Volatility", display=display.none)
plot(CB_volatilityNegative, color=#a16585, style=plot.style_histogram, title="Cross-Bar Negative Volatility", display=display.none)
plot(CB_volatilityArtifact, color=#a16585, style=plot.style_histogram, title="Cross-Bar Volatility Artifact", display=display.none)

// Comparative Cross-Bar Volatility Formulas
CCB_volatilityDifferenceTotal = visualization=="Absolute Delta" or visualization=="Unilateral" ? abs(volatilityTotal[1]-volatilityTotal[0]) : volatilityTotal[1]-volatilityTotal[0]
CCB_volatilityDifferencePositive = visualization=="Absolute Delta" or visualization=="Unilateral" ? abs(volatilityPositive[1]/volatilityPositive[0]) : volatilityPositive[1]-volatilityPositive[0]
CCB_volatilityDifferenceNegative = visualization=="Absolute Delta" or visualization=="Unilateral" ? abs(volatilityNegative[1]/volatilityNegative[0]) : volatilityNegative[1]-volatilityNegative[0]
CCB_volatilityDifferenceSignal = visualization=="Absolute Delta" or visualization=="Unilateral" ? abs(volatilitySignal[1]/volatilitySignal[0]) : volatilitySignal[1]-volatilitySignal[0]
CCB_volatilityDifferenceDelta = visualization=="Absolute Delta" or visualization=="Unilateral" ? abs(volatilityDelta[1]/volatilityDelta[0]) : volatilityDelta[1]-volatilityDelta[0]

plot(CCB_volatilityDifferenceTotal, color=#d1d4dc, style=plot.style_histogram, title="Comparative Cross-Bar Total Volatility", display=display.none)
plot(CCB_volatilityDifferencePositive, color=#568158, style=plot.style_histogram, title="Comparative Cross-Bar Positive Volatility", display=display.none)
plot(CCB_volatilityDifferenceNegative, color=#a16585, style=plot.style_histogram, title="Comparative Cross-Bar Negative Volatility", display=display.none)
plot(CCB_volatilityDifferenceSignal, color=#a16585, style=plot.style_histogram, title="Comparative Cross-Bar Signal Volatility", display=display.none)
plot(CCB_volatilityDifferenceDelta, color=#c4cd90, style=plot.style_cross, title="Comparative Cross-Bar Volatility Delta", display=display.none)